<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Datos de Facturaci√≥n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; padding: 20px; }
        .checkout-container { max-width: 800px; margin: 0 auto; }
        .ticket-summary { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .form-section { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .nav-pills .nav-link.active { background-color: #0d6efd; font-weight: bold; }
        .nav-pills .nav-link { color: #555; border: 1px solid #ddd; margin-right: 5px; border-radius: 10px; }
        .asterisk { color: red; }
    </style>
</head>
<body>

<div class="checkout-container">
    
    <div class="ticket-summary mb-4 text-center">
        <h3 class="fw-bold mb-3"><i class="fa-solid fa-lock text-warning"></i> Reserva Bloqueada</h3>
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="alert alert-info border-0 d-flex justify-content-between align-items-center">
                    <span><i class="fa-regular fa-calendar"></i> {{ reserva.start_datetime|date:"l d F" }} - {{ reserva.start_datetime|date:"H:i" }} hrs</span>
                    <span class="fs-5 fw-bold text-success">${{ reserva.asesor.hourly_rate }} CLP</span>
                </div>
                <small class="text-danger fw-bold"><i class="fa-regular fa-clock"></i> Tienes 10 minutos para completar el pago.</small>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h4 class="mb-4"><i class="fa-solid fa-file-invoice-dollar"></i> Datos de Facturaci√≥n</h4>
        
        <form method="post" id="billingForm">
            {% csrf_token %}
            <input type="hidden" name="tipo_documento" id="tipo_documento" value="BOLETA">

            <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active py-3" id="pills-boleta-tab" data-bs-toggle="pill" data-bs-target="#pills-boleta" type="button" role="tab" onclick="setTipo('BOLETA')">
                        <i class="fa-solid fa-receipt me-2"></i> BOLETA
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link py-3" id="pills-factura-tab" data-bs-toggle="pill" data-bs-target="#pills-factura" type="button" role="tab" onclick="setTipo('FACTURA')">
                        <i class="fa-solid fa-building me-2"></i> FACTURA (Empresa)
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                
                <div class="tab-pane fade show active" id="pills-boleta" role="tabpanel">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">Nombre Completo <span class="asterisk">*</span></label>
                            <input type="text" name="nombre_boleta" class="form-control" placeholder="Ej: Juan P√©rez">
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-factura" role="tabpanel">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">RUT Empresa <span class="asterisk">*</span></label>
                            <input type="text" name="rut" id="rut_input" class="form-control" placeholder="76123456-K">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Raz√≥n Social <span class="asterisk">*</span></label>
                            <input type="text" name="razon_social" class="form-control" placeholder="Ej: Servicios SpA">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Giro <span class="asterisk">*</span></label>
                            <input type="text" name="giro" class="form-control" placeholder="Ej: Servicios Inform√°ticos">
                        </div>
                    </div>
                </div>

            </div>

            <hr class="my-4">

            <h5 class="mb-3 text-muted">Datos de Contacto y Direcci√≥n</h5>
            <div class="row g-3">
                
                <div class="col-md-6">
                    <label class="form-label">Email <span class="asterisk">*</span></label>
                    <input type="email" name="email" class="form-control" value="{{ user.email }}" required>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Tel√©fono / Celular <span class="asterisk">*</span></label>
                    <div class="input-group">
                        <select class="form-select bg-light" id="prefijo_pais" style="max-width: 140px; border-right: 0;">
                            </select>
                        
                        <input type="tel" id="input_telefono" class="form-control" 
                               required 
                               placeholder="912345678">
                        
                        <input type="hidden" name="telefono" id="telefono_completo">
                    </div>
                    <div class="form-text small text-muted" id="ayuda_telefono">Selecciona el pa√≠s e ingresa el n√∫mero.</div>
                </div>
                <div class="col-md-12">
                    <label class="form-label">Direcci√≥n <span class="asterisk">*</span></label>
                    <input type="text" name="direccion" class="form-control" required placeholder="Calle, N√∫mero, Depto">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Comuna <span class="asterisk">*</span></label>
                    <input type="text" name="comuna" class="form-control" required>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Ciudad <span class="asterisk">*</span></label>
                    <input type="text" name="ciudad" class="form-control" required>
                </div>
            </div>

            <div class="mt-4 pt-2">
                <button type="submit" class="btn btn-success w-100 btn-lg fw-bold shadow">
                    <i class="fa-solid fa-credit-card me-2"></i> Ir a Pagar
                </button>
            </div>
            
            <div class="text-center mt-3">
                <a href="{% url 'pago_fallido' %}?external_reference={{ reserva.id }}" class="text-danger small text-decoration-none fw-bold">
                    <i class="fa-solid fa-times"></i> Cancelar y liberar hora
                </a>
            </div>

        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ==========================================
    // 1. CONFIGURACI√ìN DE PA√çSES (Latam + Espa√±a)
    // ==========================================
    const paises = {
        "CL": { codigo: "+56",  largo: 9,  nombre: "üá®üá± Chile",      ejemplo: "912345678" },
        "AR": { codigo: "+54",  largo: 10, nombre: "üá¶üá∑ Argentina",  ejemplo: "9112345678" },
        "ES": { codigo: "+34",  largo: 9,  nombre: "üá™üá∏ Espa√±a",     ejemplo: "612345678" },
        "MX": { codigo: "+52",  largo: 10, nombre: "üá≤üáΩ M√©xico",     ejemplo: "5512345678" },
        "PE": { codigo: "+51",  largo: 9,  nombre: "üáµüá™ Per√∫",       ejemplo: "912345678" },
        "CO": { codigo: "+57",  largo: 10, nombre: "üá®üá¥ Colombia",   ejemplo: "3001234567" },
        "VE": { codigo: "+58",  largo: 10, nombre: "üáªüá™ Venezuela",  ejemplo: "4121234567" },
        "EC": { codigo: "+593", largo: 9,  nombre: "üá™üá® Ecuador",    ejemplo: "991234567" },
        "BO": { codigo: "+591", largo: 8,  nombre: "üáßüá¥ Bolivia",    ejemplo: "71234567" },
        "UY": { codigo: "+598", largo: 9,  nombre: "üá∫üáæ Uruguay",    ejemplo: "99123456" },
        "PY": { codigo: "+595", largo: 9,  nombre: "üáµüáæ Paraguay",   ejemplo: "981234567" },
        "BR": { codigo: "+55",  largo: 11, nombre: "üáßüá∑ Brasil",     ejemplo: "11912345678" },
        "PA": { codigo: "+507", largo: 8,  nombre: "üáµüá¶ Panam√°",     ejemplo: "61234567" },
        "CR": { codigo: "+506", largo: 8,  nombre: "üá®üá∑ Costa Rica", ejemplo: "81234567" },
        "DO": { codigo: "+1",   largo: 10, nombre: "üá©üá¥ R. Dominicana", ejemplo: "8091234567" },
    };

    // Inicializar variables del Tel√©fono
    const selectPais = document.getElementById('prefijo_pais');
    const inputTel = document.getElementById('input_telefono');
    const inputHidden = document.getElementById('telefono_completo');
    const textoAyuda = document.getElementById('ayuda_telefono');

    // Llenar el Select
    for (const [key, data] of Object.entries(paises)) {
        const option = document.createElement('option');
        option.value = key;
        option.text = `${data.nombre} (${data.codigo})`;
        selectPais.appendChild(option);
    }

    // Funci√≥n al cambiar pa√≠s
    function actualizarReglasTelefono() {
        const paisKey = selectPais.value;
        const data = paises[paisKey];

        // Actualizar atributos del input
        inputTel.setAttribute('maxlength', data.largo);
        inputTel.setAttribute('minlength', data.largo);
        inputTel.placeholder = data.ejemplo;
        
        // Limpiar si no calza
        inputTel.value = inputTel.value.replace(/\D/g, '').slice(0, data.largo);
        
        textoAyuda.innerText = `Ingresa ${data.largo} d√≠gitos (sin el ${data.codigo})`;
        inputTel.classList.remove('is-invalid');
    }

    // Eventos del Tel√©fono
    selectPais.addEventListener('change', actualizarReglasTelefono);
    
    inputTel.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, ''); // Solo n√∫meros
        this.classList.remove('is-invalid');
    });

    // Iniciar con Chile
    selectPais.value = "CL";
    actualizarReglasTelefono();

    // ==========================================
    // 2. CONTROL DE PESTA√ëAS (BOLETA/FACTURA)
    // ==========================================
    function setTipo(tipo) {
        document.getElementById('tipo_documento').value = tipo;
        
        const inputsFactura = document.querySelectorAll('#pills-factura input');
        const inputBoleta = document.querySelector('input[name="nombre_boleta"]');

        if(tipo === 'FACTURA') {
            inputsFactura.forEach(i => i.required = true);
            inputBoleta.required = false;
        } else {
            inputsFactura.forEach(i => i.required = false);
            inputBoleta.required = true;
            document.getElementById('rut_input').classList.remove('is-invalid');
        }
    }
    setTipo('BOLETA'); 

    // ==========================================
    // 3. RUT: VALIDACI√ìN Y FORMATO (SIN PUNTOS)
    // ==========================================
    const rutInput = document.getElementById('rut_input');

    function formatearRut(input) {
        let valor = input.value.replace(/[^0-9kK]/g, "");
        if (valor.length > 1) {
            let cuerpo = valor.slice(0, -1);
            let dv = valor.slice(-1).toUpperCase();
            input.value = cuerpo + "-" + dv; // Solo guion
        } else {
            input.value = valor.toUpperCase();
        }
    }

    function esRutValido(rut) {
        if (!rut || rut.trim().length < 3) return false;
        const valor = rut.replace(/[^0-9kK]/g, ""); 
        if (valor.length < 2) return false;
        
        let cuerpo = valor.slice(0, -1);
        let dv = valor.slice(-1).toUpperCase();
        
        let suma = 0;
        let multiplo = 2;
        
        for (let i = cuerpo.length - 1; i >= 0; i--) {
            suma += multiplo * cuerpo.charAt(i);
            multiplo = (multiplo + 1) % 8 || 2;
        }
        
        const dvr = 11 - (suma % 11);
        let dvEsperado = (dvr === 11) ? "0" : (dvr === 10) ? "K" : dvr.toString();
        
        return dv === dvEsperado;
    }

    if(rutInput){
        rutInput.addEventListener('input', function() {
            this.classList.remove('is-invalid');
            formatearRut(this);
        });
    }

    // ==========================================
    // 4. ENV√çO DEL FORMULARIO (VALIDACI√ìN FINAL)
    // ==========================================
    document.getElementById('billingForm').addEventListener('submit', function(event) {
        // A) Validar RUT si es Factura
        const tipo = document.getElementById('tipo_documento').value;
        if (tipo === 'FACTURA') {
            const rutValor = document.querySelector('input[name="rut"]').value;
            if (!esRutValido(rutValor)) {
                event.preventDefault(); 
                alert("‚õî El RUT ingresado no es v√°lido.");
                document.querySelector('input[name="rut"]').classList.add('is-invalid');
                return false;
            }
        }

        // B) Validar Tel√©fono seg√∫n Pa√≠s
        const paisKey = selectPais.value;
        const data = paises[paisKey];
        if (inputTel.value.length !== data.largo) {
            event.preventDefault();
            alert(`‚õî El tel√©fono de ${data.nombre} debe tener ${data.largo} d√≠gitos.`);
            inputTel.classList.add('is-invalid');
            return false;
        }

        // C) Guardar n√∫mero completo en input oculto
        inputHidden.value = data.codigo + " " + inputTel.value;
    });

</script>

</body>
</html>