{% extends 'core/base.html' %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* Estilos del Calendario */
    .flatpickr-calendar {
        box-shadow: none !important;
        border: 1px solid #eee !important;
        width: 100% !important;
    }
    .flatpickr-days { width: 100% !important; }
    .dayContainer { width: 100% !important; min-width: 100% !important; }
    
    /* D√≠as con AL MENOS UNA hora disponible (Verde) */
    .flatpickr-day.disponible {
        font-weight: bold;
        background: #e6f9ee;
        border-color: #d1e7dd;
        color: #198754;
    }
    /* D√≠as completamente llenos (Gris) */
    .flatpickr-day.lleno {
        background: #f8f9fa;
        color: #adb5bd;
    }
    /* D√≠a seleccionado (Azul) */
    .flatpickr-day.selected {
        background: #0d6efd !important;
        border-color: #0d6efd !important;
        color: white !important;
    }
</style>

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                <div class="row g-0">
                    
                    <div class="col-md-4 bg-light p-4 text-center border-end">
                        <a href="{% url 'inicio' %}" class="btn btn-outline-secondary btn-sm mb-4 w-100">
                            ‚Üê Volver al buscador
                        </a>
                        
                        <div class="mb-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto shadow-sm" style="width: 80px; height: 80px; font-size: 2rem;">
                                {{ asesor.user.first_name|slice:":1" }}{{ asesor.user.last_name|slice:":1" }}
                            </div>
                        </div>

                        <h4 class="fw-bold mb-1">{{ asesor.user.first_name }} {{ asesor.user.last_name }}</h4>
                        <p class="text-muted small mb-3">{{ asesor.public_title }}</p>
                        
                        <div class="alert alert-success border-0 py-2">
                            <small class="text-uppercase fw-bold" style="font-size: 0.7rem;">Valor Sesi√≥n</small><br>
                            <span class="fs-4 fw-bold">${{ asesor.hourly_rate }}</span>
                        </div>

                        <hr>
                        <p class="small text-muted text-start">
                            <i class="fa-solid fa-clock me-1"></i> Duraci√≥n: {{ asesor.session_duration }} min<br>
                            <i class="fa-solid fa-video me-1"></i> llamada
                        </p>
                    </div>

                    <div class="col-md-8 p-4">
                        <h4 class="fw-bold mb-4">üìÖ Selecciona d√≠a y hora</h4>

                        <div class="row">
                            <div class="col-md-7 mb-4">
                                <div id="calendario-inline"></div>
                            </div>

                            <div class="col-md-5">
                                <div class="card border-0 h-100 bg-white">
                                    <div class="card-header bg-white fw-bold border-bottom-0 ps-0" id="titulo-fecha">
                                        Selecciona una fecha...
                                    </div>
                                    <div class="card-body px-0 overflow-auto" style="max-height: 350px;" id="contenedor-horas">
                                        <div class="text-center text-muted py-5 small">
                                            <i class="fa-regular fa-hand-pointer fa-2x mb-2"></i><br>
                                            Selecciona un d√≠a en el calendario.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // 1. RECUPERAR DATOS DE DJANGO
    const disponibilidad = {{ disponibilidad_json|safe }}; 
    const fechasConDatos = Object.keys(disponibilidad);

    // FUNCI√ìN EXTRA: Formatear fecha bonita (Ej: "Lunes 10 de Febrero de 2026")
    function formatearFechaBonita(fechaStr) {
        // Dividimos la fecha manualmente para evitar problemas de zona horaria
        const partes = fechaStr.split('-');
        const anio = parseInt(partes[0]);
        const mes = parseInt(partes[1]) - 1; // Meses en JS van de 0 a 11
        const dia = parseInt(partes[2]);

        const fechaObj = new Date(anio, mes, dia);
        
        const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        // Capitalizamos la primera letra (Lunes en vez de lunes)
        let fechaTexto = fechaObj.toLocaleDateString('es-ES', opciones);
        return fechaTexto.charAt(0).toUpperCase() + fechaTexto.slice(1);
    }

    // 2. INICIALIZAR FLATPICKR
    flatpickr("#calendario-inline", {
        inline: true,
        locale: "es",
        minDate: "today",
        enable: fechasConDatos,
        dateFormat: "Y-m-d",
        
        onChange: function(selectedDates, dateStr, instance) {
            actualizarHoras(dateStr);
        },

        onDayCreate: function(dObj, dStr, fp, dayElem){
            const fechaLoop = dayElem.dateObj.toISOString().split('T')[0];
            const bloques = disponibilidad[fechaLoop];

            if (bloques) {
                const hayLibres = bloques.some(b => b.disponible === true);
                if (hayLibres) {
                    dayElem.className += " disponible"; 
                } else {
                    dayElem.className += " lleno"; 
                }
            }
        }
    });

    // 3. ACTUALIZAR LISTA DE HORAS
    function actualizarHoras(fechaStr) {
        const contenedor = document.getElementById("contenedor-horas");
        const titulo = document.getElementById("titulo-fecha");
        
        // Usamos la fecha bonita aqu√≠ tambi√©n
        const fechaBonita = formatearFechaBonita(fechaStr);
        
        titulo.innerHTML = `<span class="text-primary text-capitalize">${fechaBonita}</span>`;
        contenedor.innerHTML = "";

        const bloques = disponibilidad[fechaStr];

        if (bloques && bloques.length > 0) {
            bloques.forEach(bloque => {
                
                if (bloque.disponible) {
                    // === CASO 1: DISPONIBLE (CON SWEETALERT) ===
                    const btn = document.createElement("button"); // Cambiamos a button para manejar el click mejor
                    btn.className = "btn btn-outline-primary w-100 mb-2 fw-bold text-start d-flex justify-content-between align-items-center shadow-sm";
                    btn.innerHTML = `
                        <span>${bloque.hora} hrs</span>
                        <i class="fa-solid fa-chevron-right small"></i>
                    `;
                    
                    // EVENTO CLICK CON ALERTA PERSONALIZADA
                    btn.onclick = function() {
                        Swal.fire({
                            title: '¬øConfirmar Reserva?',
                            html: `¬øQuieres reservar hora para el<br><strong>${fechaBonita}</strong><br>a las <strong>${bloque.hora} hrs</strong>?`,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonColor: '#0d6efd',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'S√≠, ir a pagar',
                            cancelButtonText: 'Cancelar'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // Si dice que S√ç, lo mandamos a la URL
                                let urlReserva = "{% url 'reservar_hora' 0 %}".replace('0', bloque.id);
                                window.location.href = urlReserva;
                            }
                        });
                    };

                    contenedor.appendChild(btn);

                } else {
                    // === CASO 2: OCUPADO ===
                    const div = document.createElement("div");
                    div.className = "btn btn-light w-100 mb-2 text-muted text-start d-flex justify-content-between align-items-center border";
                    div.style.cursor = "not-allowed"; 
                    div.style.opacity = "0.6";
                    div.innerHTML = `
                        <span class="text-decoration-line-through">${bloque.hora} hrs</span>
                        <span class="badge bg-secondary rounded-pill" style="font-size: 0.7rem;">Reservada</span>
                    `;
                    contenedor.appendChild(div);
                }
            });
        } else {
            contenedor.innerHTML = '<p class="text-muted small mt-3">No hay horas registradas para este d√≠a.</p>';
        }
    }
</script>
{% endblock %}