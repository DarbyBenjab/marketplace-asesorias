{% extends 'core/base.html' %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

<style>
    /* Estilos personalizados para el calendario */
    .flatpickr-calendar {
        box-shadow: none !important;
        border: 1px solid #eee !important;
        width: 100% !important;
    }
    .flatpickr-days { width: 100% !important; }
    .dayContainer { width: 100% !important; min-width: 100% !important; }
    
    /* D√≠as disponibles en verde o negrita */
    .flatpickr-day.disponible {
        font-weight: bold;
        background: #e6f9ee;
        border-color: #d1e7dd;
        color: #198754;
    }
    .flatpickr-day.selected {
        background: #0d6efd !important;
        border-color: #0d6efd !important;
        color: white !important;
    }
</style>

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                <div class="row g-0">
                    
                    <div class="col-md-4 bg-light p-4 text-center border-end">
                        <a href="{% url 'inicio' %}" class="btn btn-outline-secondary btn-sm mb-4 w-100">
                            ‚Üê Volver al buscador
                        </a>
                        
                        <div class="mb-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto shadow-sm" style="width: 80px; height: 80px; font-size: 2rem;">
                                {{ asesor.user.first_name|slice:":1" }}{{ asesor.user.last_name|slice:":1" }}
                            </div>
                        </div>

                        <h4 class="fw-bold mb-1">{{ asesor.user.first_name }} {{ asesor.user.last_name }}</h4>
                        <p class="text-muted small mb-3">{{ asesor.public_title }}</p>
                        
                        <div class="alert alert-success border-0 py-2">
                            <small class="text-uppercase fw-bold" style="font-size: 0.7rem;">Valor Sesi√≥n</small><br>
                            <span class="fs-4 fw-bold">${{ asesor.hourly_rate }}</span>
                        </div>

                        <hr>
                        <p class="small text-muted text-start">
                            <i class="fa-solid fa-clock me-1"></i> Duraci√≥n: {{ asesor.session_duration }} min<br>
                            <i class="fa-solid fa-video me-1"></i> llamada
                        </p>
                    </div>

                    <div class="col-md-8 p-4">
                        <h4 class="fw-bold mb-4">üìÖ Selecciona d√≠a y hora</h4>

                        <div class="row">
                            <div class="col-md-7 mb-4">
                                <div id="calendario-inline"></div>
                            </div>

                            <div class="col-md-5">
                                <div class="card border-0 h-100 bg-white">
                                    <div class="card-header bg-white fw-bold border-bottom-0 ps-0" id="titulo-fecha">
                                        Selecciona una fecha...
                                    </div>
                                    <div class="card-body px-0" id="contenedor-horas">
                                        <div class="text-center text-muted py-5 small">
                                            <i class="fa-regular fa-hand-pointer fa-2x mb-2"></i><br>
                                            Elige un d√≠a verde en el calendario.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // 1. RECUPERAR DATOS DE DJANGO
    // 'safe' es vital para que JS lea el JSON correctamente
    const disponibilidad = {{ disponibilidad_json|safe }}; 
    
    // Extraer solo las fechas que tienen horarios (Keys del diccionario)
    const fechasActivas = Object.keys(disponibilidad);

    // 2. INICIALIZAR FLATPICKR
    flatpickr("#calendario-inline", {
        inline: true,              // Calendario siempre visible
        locale: "es",              // Idioma espa√±ol
        minDate: "today",          // No permitir pasado
        enable: fechasActivas,     // SOLO habilitar d√≠as con horas
        dateFormat: "Y-m-d",
        
        // 3. EVENTO AL HACER CLIC EN UN D√çA
        onChange: function(selectedDates, dateStr, instance) {
            actualizarHoras(dateStr);
        },

        // Clase CSS para d√≠as habilitados
        onDayCreate: function(dObj, dStr, fp, dayElem){
            // Convertir la fecha del calendario a YYYY-MM-DD local para comparar
            // Truco para evitar problemas de zona horaria en JS puro:
            const fechaLoop = dayElem.dateObj.toISOString().split('T')[0];
            
            if (fechasActivas.includes(fechaLoop)) {
                dayElem.className += " disponible";
            }
        }
    });

    // 4. FUNCI√ìN PARA PINTAR BOTONES
    function actualizarHoras(fechaStr) {
        const contenedor = document.getElementById("contenedor-horas");
        const titulo = document.getElementById("titulo-fecha");
        
        // Formatear t√≠tulo bonito (Opcional, JS b√°sico)
        titulo.innerHTML = `<span class="text-primary">Horarios para el ${fechaStr}</span>`;
        contenedor.innerHTML = ""; // Limpiar anterior

        // Buscar en el JSON
        const bloques = disponibilidad[fechaStr];

        if (bloques && bloques.length > 0) {
            // Crear botones
            bloques.forEach(bloque => {
                const btn = document.createElement("a");
                // Construimos la URL de Django reemplazando el ID dummy '0'
                // Truco: Usamos una URL base y le pegamos el ID
                let urlReserva = "{% url 'reservar_hora' 0 %}".replace('0', bloque.id);
                
                btn.href = urlReserva;
                btn.className = "btn btn-outline-primary w-100 mb-2 fw-bold text-start";
                btn.innerHTML = `${bloque.hora} hrs <i class="fa-solid fa-chevron-right float-end mt-1 small"></i>`;
                
                // Confirmaci√≥n
                btn.onclick = function() {
                    return confirm(`¬øReservar cita para el ${fechaStr} a las ${bloque.hora}?`);
                };

                contenedor.appendChild(btn);
            });
        } else {
            contenedor.innerHTML = '<p class="text-muted small">No hay horas disponibles.</p>';
        }
    }
</script>
{% endblock %}