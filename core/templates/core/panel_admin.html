{% extends 'core/base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold"><i class="fa-solid fa-screwdriver-wrench"></i> Panel de AdministraciÃ³n</h2>
        <div>
            <a href="{% url 'admin_chat_dashboard' %}" class="btn btn-warning fw-bold me-2 position-relative">
                <i class="fa-solid fa-comments"></i> Ver Chats
                {% if mensajes_sin_leer > 0 %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-light">
                    {{ mensajes_sin_leer }}
                </span>
                {% endif %}
            </a>

            <a href="{% url 'dashboard_financiero' %}" class="btn btn-primary fw-bold">
                <i class="fa-solid fa-chart-line"></i> Ver Dashboard Financiero
            </a>
            <a href="{% url 'inicio' %}" class="btn btn-outline-dark ms-2">Volver al sitio web</a>
        </div>
    </div>

    <div class="card shadow-sm mb-4 border-warning">
        <div class="card-header bg-warning text-dark fw-bold">
            <i class="fa-solid fa-bell"></i> Solicitudes Pendientes ({{ pendientes_count }})
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre</th>
                            <th>TÃ­tulo Profesional</th>
                            <th>Experiencia</th> 
                            <th>CV</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for perfil in solicitudes %}
                        <tr>
                            <td>
                                <div class="fw-bold">{{ perfil.user.first_name }} {{ perfil.user.last_name }}</div>
                                <small class="text-muted">{{ perfil.user.email }}</small>
                            </td>
                            <td>{{ perfil.public_title }}</td>
                            
                            <td>
                                {{ perfil.experience_summary|truncatechars:30 }}
                                <button type="button" class="btn btn-link btn-sm p-0 text-decoration-none fw-bold" data-bs-toggle="modal" data-bs-target="#expModal{{ perfil.id }}">
                                    <i class="fa-solid fa-eye"></i> Leer completo
                                </button>

                                <div class="modal fade" id="expModal{{ perfil.id }}" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title fw-bold">Experiencia de {{ perfil.user.first_name }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body" style="white-space: pre-wrap;">{{ perfil.experience_summary }}</div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>

                            <td>
                                {% if perfil.cv_file %}
                                    <a href="{{ perfil.cv_file.url }}" target="_blank" class="btn btn-sm btn-info text-white">
                                        <i class="fa-solid fa-file-pdf"></i> Ver PDF
                                    </a>
                                {% else %}
                                    <span class="text-muted">Sin CV</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <a href="{% url 'aprobar_asesor' perfil.id %}" class="btn btn-success btn-sm fw-bold">
                                    <i class="fa-solid fa-check"></i> Aceptar
                                </a>
                                <a href="{% url 'rechazar_asesor' perfil.id %}" class="btn btn-danger btn-sm fw-bold ms-1" onclick="return confirm('Â¿Borrar esta solicitud?')">
                                    <i class="fa-solid fa-xmark"></i> Rechazar
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                No hay solicitudes pendientes.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4 border-success">
        <div class="card-header bg-success text-white fw-bold">
            <i class="fa-solid fa-check-circle"></i> Asesores Activos ({{ asesores|length }})
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Asesor</th>
                            <th>Precio Hora</th>
                            <th>DuraciÃ³n</th>
                            <th class="text-end">Herramientas de Jefe</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asesor in asesores %}
                        <tr>
                            <td>
                                <div class="fw-bold">{{ asesor.user.first_name }} {{ asesor.user.last_name }}</div>
                                <span class="badge bg-light text-dark border">{{ asesor.public_title }}</span>
                            </td>
                            <td class="fw-bold text-success fs-5">${{ asesor.hourly_rate }}</td>
                            <td><span class="badge bg-info text-dark">{{ asesor.session_duration }} min</span></td>
                            
                            <td class="text-end">
                                <div class="btn-group">
                                    <a href="{% url 'admin_editar_precio' asesor.id %}" class="btn btn-outline-primary btn-sm" title="Editar Precio">
                                        <i class="fa-solid fa-dollar-sign"></i> Precio
                                    </a>
                                    <a href="{% url 'admin_editar_duracion' asesor.id %}" class="btn btn-outline-dark btn-sm" title="Editar Tiempo">
                                        <i class="fa-solid fa-clock"></i> Tiempo
                                    </a>
                                    
                                    <a href="{% url 'admin_chat_detail' asesor.user.id %}" class="btn btn-outline-warning btn-sm" title="Abrir Chat con Asesor">
                                        <i class="fa-solid fa-comments"></i> Chat
                                    </a>

                                    <a href="{% url 'rechazar_asesor' asesor.id %}" class="btn btn-outline-danger btn-sm" onclick="return confirm('Â¿Despedir y eliminar a este asesor?')">
                                        <i class="fa-solid fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-4 text-muted">
                                No hay asesores activos. Â¡Acepta a alguien de arriba! ðŸ‘†
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-danger mb-4">
        <div class="card-header bg-danger text-white fw-bold">
            <i class="fa-solid fa-triangle-exclamation"></i> Reclamos y Solicitudes de Reembolso
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID Cita</th>
                            <th>Cliente</th>
                            <th>Asesor Acusado</th>
                            <th>Motivo del Reclamo</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reclamo in reclamos %}
                        <tr class="table-danger">
                            <td>#{{ reclamo.id }}</td>
                            <td>{{ reclamo.client.first_name }} {{ reclamo.client.last_name }}</td>
                            <td>{{ reclamo.asesor.user.first_name }}</td>
                            <td>{{ reclamo.reclamo_mensaje }}</td>
                            <td class="text-end">
                                <a href="{% url 'resolver_reclamo' reclamo.id 'aprobar' %}" class="btn btn-success btn-sm">
                                    Reembolsar
                                </a>
                                <a href="{% url 'resolver_reclamo' reclamo.id 'rechazar' %}" class="btn btn-dark btn-sm">
                                    Ignorar
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                âœ¨ No hay reclamos pendientes. Todo funciona bien.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 rounded-4 mb-5">
        <div class="card-header bg-warning text-dark fw-bold py-3 d-flex justify-content-between align-items-center">
            <span><i class="fa-solid fa-envelope-open-text me-2"></i> Bandeja de Entrada (Soporte)</span>
            <span class="badge bg-dark">{{ mensajes_soporte.count }} Mensajes</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Fecha</th>
                            <th>Tipo</th>
                            <th>Usuario</th>
                            <th>Mensaje</th>
                            <th>Adjunto</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for msg in mensajes_soporte %}
                        <tr>
                            <td class="ps-4 text-muted small">{{ msg.fecha_envio|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if msg.tipo == 'RECLAMO' %}
                                    <span class="badge bg-danger">Reclamo</span>
                                {% elif msg.tipo == 'SUGERENCIA' %}
                                    <span class="badge bg-info text-dark">Sugerencia</span>
                                {% else %}
                                    <span class="badge bg-success">FelicitaciÃ³n</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ msg.nombre }}</strong><br>
                                <small class="text-muted">{{ msg.email }}</small><br>
                                <small class="text-muted">{{ msg.telefono }}</small>
                            </td>
                            <td>
                                <div style="max-width: 300px; white-space: pre-wrap;" class="small">{{ msg.mensaje }}</div>
                            </td>
                            <td>
                                {% if msg.archivo %}
                                    <a href="{{ msg.archivo.url }}" target="_blank" class="btn btn-sm btn-outline-dark">
                                        <i class="fa-solid fa-paperclip"></i> Ver Archivo
                                    </a>
                                {% else %}
                                    <span class="text-muted small">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                <i class="fa-regular fa-folder-open fa-2x mb-2 d-block"></i>
                                No hay mensajes nuevos en el buzÃ³n.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}
